# Run command:
# snakemake --reason --cores 180 --cluster "qsub -pe smp 10 -N smk.infercnv -b y -j y -V -P TumourProgression" -j 18

# DAG command:
# snakemake --dag | dot -Tsvg > dag.svg

# define directories:
R_dir = "/share/ClusterShare/software/contrib/briglo/octR/src/R-3.6.0/builddir/bin/"

# define variables:
SAMPLES = list(range(1, 31, 1))
#SAMPLES = list([1,2])
SAMPLES = list(map(str, SAMPLES))
samples = SAMPLES[0] + '_' + SAMPLES[-1]
PERMUTATION_PROPORTIONS = list([0.01, 0.05, 0.1, 0.2, 0.3, 0.4])
#PERMUTATION_PROPORTIONS = list([0.1, 0.2])
PERMUTATION_PROPORTIONS = list(map(str, PERMUTATION_PROPORTIONS))
permutation_proportions = '_'.join(PERMUTATION_PROPORTIONS)

# normal infercnv parameters:
normal_name = "CID4520N"
nUMI_threshold="25000"
nGene_threshold="5000"
analysis_mode="samples"

# filter normal:
neutral_signal_range = "0.97_1.03"

# permutate normal parameters:
potential_values="0_0.5_1.5_2_3"

# infercnv parameters:
permutated_normal_name = "permutated_CID4520N"

# permutated normal plot parameters:
min_artefact_length = "20"
min_artefact_proportion = "0.4"


######
#rule all:
#    input:
#        "results/infercnv/{sample_name}/" + 
#        "{analysis_mode}_mode/infercnv.12_denoised.png"
######

#######
#rule all:
#    input:
#        expand(
#            "results/infercnv/{permutated_normal_name}/" + 
#            "{permutation_proportion}_proportion/{sample}/input_files/input_matrix.txt",
#            permutated_normal_name=permutated_normal_name, permutation_proportion=permutation_proportion,
#            sample=SAMPLES
#        )
#######

#######
#rule all:
#    input:
#        expand(
#        "results/infercnv/{permutated_normal_name}/" + 
#            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
#            "infercnv.12_denoised.png",
#            permutated_normal_name=permutated_normal_name, permutation_proportion=permutation_proportion,
#            sample=SAMPLES, analysis_mode=analysis_mode
#        )
#####

#####
#rule all:
#    input:
#        expand(
#        "results/infercnv/{permutated_normal_name}/" + 
#            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
#            "plots/infercnv_plot_with_artefact_calls.pdf",
#            permutated_normal_name=permutated_normal_name, permutation_proportion=PERMUTATION_PROPORTIONS,
#            sample=SAMPLES, analysis_mode=analysis_mode
#        )
######

rule all:
    input:
        expand(
        "results/infercnv/{permutated_normal_name}/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" +
            "{min_artefact_length}_min_artefact_length/" +
            "final_plots/artefact_results.png",
            permutated_normal_name=permutated_normal_name,
            min_artefact_proportion=min_artefact_proportion,
            min_artefact_length=min_artefact_length
        )

rule normal_infercnv:
    input:
        "raw_files/seurat_objects/{normal_name}/03_seurat_object_processed.Rdata"

    output:
        "results/infercnv/{normal_name}/{analysis_mode}_mode" + 
            "/infercnv.12_denoised.png"
    threads: 10
    shell:
        "module load briglo/R/3.6.0; " + 
        "mkdir -p logs/normal_infercnv/; " +
        "cd logs/normal_infercnv/; " + 
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {normal_name}" + 
        " {threads}" + 
        " {nUMI_threshold}" +
        " {nGene_threshold}" + 
        " {analysis_mode}" +  
        "' ../../scripts/1b.normal_infercnv.R"

rule filter_normal:
    input:
        "results/infercnv/{normal_name}/{analysis_mode}_mode" + 
            "/infercnv.12_denoised.png"
    output:
        "results/infercnv/{normal_name}/filtered/{analysis_mode}_mode" + 
            "/infercnv.12_denoised.png"
    threads: 10
    shell:
        "module load briglo/R/3.6.0; " + 
        "mkdir -p logs/filtered_normal/; " +
        "cd logs/filtered_normal/; " + 
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {normal_name}" + 
        " {analysis_mode}" +
        " {neutral_signal_range}" +  
        " {threads}" + 
        "' ../../scripts/2b.filter_normal.R"

rule permutate_normal:
    input:
        seurat_input = expand(
            "raw_files/seurat_objects/{normal_name}/03_seurat_object_processed.Rdata",
            normal_name=normal_name
        ),
        filtered_infercnv = expand(
            "results/infercnv/{normal_name}/filtered/{analysis_mode}_mode" + 
            "/infercnv.12_denoised.png",
            normal_name=normal_name, analysis_mode=analysis_mode
        )
    output:
        matrix = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/input_files/input_matrix.txt",
        metadata = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/input_files/metadata.txt"
    threads: 10
    shell:
        "module load briglo/R/3.6.0; "
        "mkdir -p logs/permutate_normal/{wildcards.permutation_proportion}_proportion/{wildcards.sample}/; " +
        "cd logs/permutate_normal/{wildcards.permutation_proportion}_proportion/{wildcards.sample}/; " + 
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {normal_name}" + 
        " {nUMI_threshold}" +
        " {nGene_threshold}" + 
        " {wildcards.permutation_proportion}" + 
        " {potential_values}" + 
        " {wildcards.sample} " + 
        " {analysis_mode}" + 
        " {neutral_signal_range}" + 
        "' ../../../../scripts/3b.randomly_permutate_normal.R"

rule permutated_normal_infercnv:
    input:
        matrix = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/input_files/input_matrix.txt",
        metadata = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/input_files/metadata.txt"
    output:
        "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "infercnv.12_denoised.png"
    threads: 10
    shell:
        "module load briglo/R/3.6.0; "
        "mkdir -p logs/infercnv/{wildcards.permutation_proportion}_proportion/" + 
        "{wildcards.sample}/{analysis_mode}.mode/; " +
        "cd logs/infercnv/{wildcards.permutation_proportion}_proportion/" + 
        "{wildcards.sample}/{analysis_mode}.mode/; " + 
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {permutated_normal_name}" + 
        " {threads}" +
        " {analysis_mode}" + 
        " {wildcards.permutation_proportion}" +
        " {wildcards.sample} " +
        "' ../../../../../scripts/4b.permutated_normal_infercnv.R"

rule permutated_normal_plot:
    input:
        "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "infercnv.12_denoised.png"
    output:
        heatmap_plot = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/" +
            "plots/infercnv_plot_with_artefact_calls.pdf",
#        annot_plot = "results/infercnv/{permutated_normal_name}/" + 
#            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
#            "{min_artefact_proportion}_min_artefact_proportion/" + 
#            "{min_artefact_length}_min_artefact_length/" +
#            "plots/annotated_artefact_level_plot.png",            
        artefact_count = "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/"
            "tables/artefact_counts.txt"
    threads: 10
    shell:
        "module load briglo/R/3.6.0; "
        "mkdir -p logs/plot/{wildcards.permutation_proportion}/{wildcards.sample}/{analysis_mode}.mode/" +
        "{min_artefact_proportion}_min_artefact_proportion/" + 
        "{min_artefact_length}_min_artefact_length/; "
        "cd logs/plot/{wildcards.permutation_proportion}/{wildcards.sample}/{analysis_mode}.mode/" + 
        "{min_artefact_proportion}_min_artefact_proportion/" + 
        "{min_artefact_length}_min_artefact_length/; "
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {permutated_normal_name}" + 
        " {wildcards.permutation_proportion}" + 
        " {wildcards.sample} " +       
        " {analysis_mode}" + 
        " {neutral_signal_range}" + 
        " {min_artefact_proportion}" + 
        " {min_artefact_length}" +
        "' ../../../../../../../scripts/5b.plot_individual_heatmap.R"

rule pdf_to_png:
    input:
        "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/" +
            "plots/infercnv_plot_with_artefact_calls.pdf"
    output:
        "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/" +
            "plots/infercnv_plot_with_artefact_calls.png"
    shell:
        "convert -density 150 {input} -quality 90 {output}"

rule final_plot:
    input:
        heatmap_plot = expand(
            "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/" +
            "plots/infercnv_plot_with_artefact_calls.png",
            permutated_normal_name=permutated_normal_name, permutation_proportion=PERMUTATION_PROPORTIONS,
            sample=SAMPLES, analysis_mode=analysis_mode, 
            min_artefact_proportion=min_artefact_proportion,
            min_artefact_length=min_artefact_length
        ),
#        annot_plot = expand(
#            "results/infercnv/{permutated_normal_name}/" + 
#            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
#            "{min_artefact_proportion}_min_artefact_proportion/" + 
#            "{min_artefact_length}_min_artefact_length/" +
#            "plots/annotated_artefact_level_plot.png",
#            permutated_normal_name=permutated_normal_name, permutation_proportion=PERMUTATION_PROPORTIONS,
#            sample=SAMPLES, analysis_mode=analysis_mode,
#            min_artefact_proportion=min_artefact_proportion,
#            min_artefact_length=min_artefact_length
#        ),
        artefact_count = expand(
            "results/infercnv/{permutated_normal_name}/" + 
            "{permutation_proportion}_proportion/{sample}/{analysis_mode}_mode/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" + 
            "{min_artefact_length}_min_artefact_length/" +
            "tables/artefact_counts.txt",
            permutated_normal_name=permutated_normal_name, permutation_proportion=PERMUTATION_PROPORTIONS,
            sample=SAMPLES, analysis_mode=analysis_mode,
            min_artefact_proportion=min_artefact_proportion,
            min_artefact_length=min_artefact_length
        )
    output:
        plot = "results/infercnv/{permutated_normal_name}/" + 
            "{min_artefact_proportion}_min_artefact_proportion/" +
            "{min_artefact_length}_min_artefact_length/" +
            "final_plots/artefact_results.png",
    threads: 10
    shell:
        "module load briglo/R/3.6.0; "
        "mkdir -p logs/final_plot/{analysis_mode}.mode/; " +
        "cd logs/final_plot/{analysis_mode}.mode/; " + 
        "{R_dir}/R CMD BATCH  --no-save '--args" + 
        " {permutated_normal_name}" + 
        " {permutation_proportions}" + 
        " {samples}" +
        " {analysis_mode}" +
        " {min_artefact_proportion}" +
        " {min_artefact_length}" +
        "' ../../../scripts/6.plot_final_call_proportions.R"



